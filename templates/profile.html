{% extends 'base.html' %}

{% block title %}LoveFinder - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    </h5>
                </div>
                <div class="card-body text-center" id="profileMainContent">
                    {% if user.is_authenticated and user.profile %}
                    <div class="mb-3">
                        {% with main_photo=user.profile.photos.all|first %}
                        {% if main_photo and main_photo.is_main %}
                            <img src="{{ main_photo.image.url }}" class="rounded-circle" width="150" height="150" 
                                 style="object-fit: cover; cursor: pointer;" alt="Profile Photo"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTBkNWZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+0JjQvdC+0YMg0L/QvtC00LrQsNC30L3QsDwvdGV4dD4KPC9zdmc+'">
                        {% else %}
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTBkNWZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+0JjQvdC+0YMg0L/QvtC00LrQsNC30L3QsDwvdGV4dD4KPC9zdmc+" 
                                 class="rounded-circle" width="150" height="150" 
                                 style="object-fit: cover; cursor: pointer;" alt="Default Profile Photo">
                        {% endif %}
                        {% endwith %}
                    </div>
                    <h4>{{ user.get_full_name|default:user.username }}</h4>
                    <p class="text-muted">
                        {% if user.profile.age is not None %}
                            {{ user.profile.age }} –ª–µ—Ç,
                        {% endif %}
                        {{ user.profile.city|default:"–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω" }}
                    </p>
                    
                    <div class="mb-3">
                        <span class="badge bg-{{ user.profile.status_color|default:'secondary' }}">
                            {{ user.profile.get_status_display|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
                        </span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-images me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-warning" id="noProfileAlert">
                        <p>–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω</p>
                        <button class="btn btn-sm btn-primary" id="createProfileBtn">
                            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                        </button>
                    </div>
                    <div id="profileContent" style="display: none;">
                        <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card mt-4" id="profileStats" style="display: none;">
                <div class="card-header">
                    <h6 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-primary" id="likesCount">0</h5>
                            <small>–õ–∞–π–∫–æ–≤</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-success" id="matchesCount">0</h5>
                            <small>–ú—ç—Ç—á–µ–π</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-info" id="viewsCount">0</h5>
                            <small>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="col-lg-8">
            <div id="profileDetails">
                {% if user.is_authenticated and user.profile %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">–û —Å–µ–±–µ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-venus-mars me-2 text-muted"></i>–ü–æ–ª:</strong>
                                <span class="ms-2">{{ user.profile.get_gender_display|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-birthday-cake me-2 text-muted"></i>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong>
                                <span class="ms-2">{{ user.profile.birth_date|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>–ì–æ—Ä–æ–¥:</strong>
                                <span class="ms-2">{{ user.profile.city|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-heart me-2 text-muted"></i>–£–≤–ª–µ—á–µ–Ω–∏—è:</strong>
                            <div class="mt-2" id="hobbiesList">
                                {% if user.profile.hobbies %}
                                    {% for hobby in user.profile.hobbies_list %}
                                    <span class="badge bg-light text-dark me-1 mb-1">{{ hobby }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-file-alt me-2 text-muted"></i>–û —Å–µ–±–µ:</strong>
                            <p class="mt-2" id="profileBio">{{ user.profile.bio|default:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ." }}</p>
                        </div>
                    </div>
                </div>

                <!-- –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–ú–æ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="photo-gallery">
                            {% for photo in user.profile.photos.all %}
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="photo-container position-relative">
                                    <img src="{{ photo.image.url }}" class="img-fluid rounded" 
                                         style="height: 200px; width: 100%; object-fit: cover; cursor: pointer;"
                                         data-bs-toggle="modal" data-bs-target="#photoModal"
                                         data-photo-src="{{ photo.image.url }}"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSI+0J7RgtC/0YDQsNCy0LvQtdC90Lg8L3RleHQ+Cjwvc3ZnPg=='">
                                    {% if photo.is_main %}
                                    <span class="position-absolute top-0 start-0 badge bg-primary m-1">–û—Å–Ω–æ–≤–Ω–∞—è</span>
                                    {% endif %}
                                    <div class="position-absolute top-0 end-0 m-1">
                                        <button class="btn btn-sm btn-outline-danger delete-photo" data-photo-id="{{ photo.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <small class="text-muted">{{ photo.caption|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</small>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                <p class="text-muted">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                                    <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card" id="emptyProfileCard">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h4>–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞–Ω</h4>
                        <p class="text-muted">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –µ–≥–æ —Å–æ–∑–¥–∞—Ç—å</p>
                        <button class="btn btn-primary btn-lg" id="createProfileBtnMain">
                            <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                        </button>
                    </div>
                </div>
                <div id="profileDetailsContent" style="display: none;">
                    <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileEditForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ò–º—è</label>
                                <input type="text" class="form-control" name="first_name" id="editFirstName" value="{{ user.first_name }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                                <input type="text" class="form-control" name="last_name" id="editLastName" value="{{ user.last_name }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–ª</label>
                        <select class="form-select" name="gender" id="editGender">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</option>
                            <option value="M" {% if user.profile.gender == 'M' %}selected{% endif %}>–ú—É–∂—Å–∫–æ–π</option>
                            <option value="F" {% if user.profile.gender == 'F' %}selected{% endif %}>–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                        <input type="date" class="form-control" name="birth_date" id="editBirthDate" value="{{ user.profile.birth_date|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ì–æ—Ä–æ–¥</label>
                        <input type="text" class="form-control" name="city" id="editCity" value="{{ user.profile.city }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" name="status" id="editStatus">
                            <option value="single" {% if user.profile.status == 'single' %}selected{% endif %}>–í –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ</option>
                            <option value="dating" {% if user.profile.status == 'dating' %}selected{% endif %}>–í—Å—Ç—Ä–µ—á–∞—é—Å—å</option>
                            <option value="married" {% if user.profile.status == 'married' %}selected{% endif %}>–ñ–µ–Ω–∞—Ç/–ó–∞–º—É–∂–µ–º</option>
                            <option value="complicated" {% if user.profile.status == 'complicated' %}selected{% endif %}>–í—Å–µ —Å–ª–æ–∂–Ω–æ</option>
                            <option value="not_looking" {% if user.profile.status == 'not_looking' %}selected{% endif %}>–ù–µ –∏—â—É –æ—Ç–Ω–æ—à–µ–Ω–∏—è</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–£–≤–ª–µ—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                        <textarea class="form-control" name="hobbies" id="editHobbies" rows="3" placeholder="–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –º—É–∑—ã–∫–∞, —Å–ø–æ—Ä—Ç...">{{ user.profile.hobbies }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–û —Å–µ–±–µ</label>
                        <textarea class="form-control" name="bio" id="editBio" rows="4" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...">{{ user.profile.bio }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveProfileChanges">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="photoManagerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="photoUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</label>
                        <input type="file" class="form-control" name="image" id="photoInput" accept="image/*" required>
                        <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ</label>
                        <input type="text" class="form-control" name="caption" id="photoCaption" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å...">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_main" id="setAsMain">
                        <label class="form-check-label" for="setAsMain">
                            –°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π –ø—Ä–æ—Ñ–∏–ª—è
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="uploadButton">
                        <i class="fas fa-upload me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhoto" src="" class="img-fluid" style="max-height: 70vh; object-fit: contain;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞
async function checkAndRefreshToken() {
    const accessToken = localStorage.getItem('accessToken');
    const refreshToken = localStorage.getItem('refreshToken');
    
    if (!accessToken) {
        console.log('‚ùå –ù–µ—Ç access token, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
        window.location.href = '{% url "login" %}';
        return null;
    }
    
    try {
        const response = await fetch('/api/users/profiles/me/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            }
        });
        
        if (response.ok) {
            console.log('‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω');
            return accessToken;
        }
        
        if (response.status === 401 && refreshToken) {
            console.log('üîÑ –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å...');
            const refreshResponse = await fetch('/api/token/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    refresh: refreshToken
                })
            });
            
            if (refreshResponse.ok) {
                const tokens = await refreshResponse.json();
                localStorage.setItem('accessToken', tokens.access);
                console.log('‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω');
                return tokens.access;
            }
        }
        
        console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω');
        window.location.href = '{% url "login" %}';
        return null;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
        window.location.href = '{% url "login" %}';
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö API
function updateProfileUI(profileData) {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', profileData);
    
    if (profileData && profileData.id) {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è "–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞–Ω"
        const noProfileAlert = document.getElementById('noProfileAlert');
        const emptyProfileCard = document.getElementById('emptyProfileCard');
        
        if (noProfileAlert) noProfileAlert.style.display = 'none';
        if (emptyProfileCard) emptyProfileCard.style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const profileContent = document.getElementById('profileContent');
        const profileDetailsContent = document.getElementById('profileDetailsContent');
        
        if (profileContent) {
            profileContent.style.display = 'block';
            profileContent.innerHTML = `
                <div class="mb-3">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTBkNWZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+0JjQvdC+0YMg0L/QvtC00LrQsNC30L3QsDwvdGV4dD4KPC9zdmc+" 
                         class="rounded-circle" width="150" height="150" 
                         style="object-fit: cover; cursor: pointer;" alt="Profile Photo">
                </div>
                <h4>${profileData.first_name || ''} ${profileData.last_name || ''}</h4>
                <p class="text-muted">
                    ${profileData.age ? profileData.age + ' –ª–µ—Ç,' : ''}
                    ${profileData.city || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}
                </p>
                
                <div class="mb-3">
                    <span class="badge bg-secondary">
                        ${profileData.status_display || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </span>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                        <i class="fas fa-images me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
                    </button>
                </div>
            `;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è
        if (profileDetailsContent) {
            profileDetailsContent.style.display = 'block';
            profileDetailsContent.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">–û —Å–µ–±–µ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-venus-mars me-2 text-muted"></i>–ü–æ–ª:</strong>
                                <span class="ms-2">${profileData.gender === 'M' ? '–ú—É–∂—Å–∫–æ–π' : profileData.gender === 'F' ? '–ñ–µ–Ω—Å–∫–∏–π' : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-birthday-cake me-2 text-muted"></i>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong>
                                <span class="ms-2">${profileData.birth_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>–ì–æ—Ä–æ–¥:</strong>
                                <span class="ms-2">${profileData.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-heart me-2 text-muted"></i>–£–≤–ª–µ—á–µ–Ω–∏—è:</strong>
                            <div class="mt-2">
                                ${profileData.hobbies ? 
                                    profileData.hobbies.split(',').map(hobby => 
                                        `<span class="badge bg-light text-dark me-1 mb-1">${hobby.trim()}</span>`
                                    ).join('') : 
                                    '<span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>'
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-file-alt me-2 text-muted"></i>–û —Å–µ–±–µ:</strong>
                            <p class="mt-2">${profileData.bio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ.'}</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–ú–æ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                <p class="text-muted">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                                    <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const profileStats = document.getElementById('profileStats');
        if (profileStats) {
            profileStats.style.display = 'block';
            document.getElementById('likesCount').textContent = profileData.likes_count || 0;
            document.getElementById('matchesCount').textContent = profileData.matches_count || 0;
            document.getElementById('viewsCount').textContent = profileData.views_count || 0;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (document.getElementById('editFirstName')) {
            document.getElementById('editFirstName').value = profileData.first_name || '';
            document.getElementById('editLastName').value = profileData.last_name || '';
            document.getElementById('editGender').value = profileData.gender || '';
            document.getElementById('editBirthDate').value = profileData.birth_date || '';
            document.getElementById('editCity').value = profileData.city || '';
            document.getElementById('editStatus').value = profileData.status || 'single';
            document.getElementById('editHobbies').value = profileData.hobbies || '';
            document.getElementById('editBio').value = profileData.bio || '';
        }
        
        console.log('‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    console.log('Profile page loaded');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–æ–ª—É—á–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
    const validToken = await checkAndRefreshToken();
    if (!validToken) {
        return;
    }
    
    console.log('Using valid token');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ API
    try {
        const response = await fetch('/api/users/profiles/me/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + validToken
            }
        });
        
        console.log('Profile API response status:', response.status);
        
        if (response.ok) {
            const profileData = await response.json();
            console.log('Profile data loaded:', profileData);
            updateProfileUI(profileData);
        } else {
            console.log('Profile load failed:', response.status);
        }
    } catch (error) {
        console.log('Profile load error:', error.message);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('createProfileBtn')?.addEventListener('click', function() {
        createProfile(validToken);
    });
    
    document.getElementById('createProfileBtnMain')?.addEventListener('click', function() {
        createProfile(validToken);
    });

    function createProfile(token) {
        fetch('/api/users/profiles/me/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                city: '–ù–µ —É–∫–∞–∑–∞–Ω',
                bio: '–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å'
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
        })
        .then(data => {
            alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω!');
            location.reload();
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        });
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.querySelectorAll('[data-bs-target="#photoModal"]').forEach(element => {
        element.addEventListener('click', function() {
            const photoSrc = this.getAttribute('data-photo-src');
            document.getElementById('modalPhoto').src = photoSrc;
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
    document.getElementById('photoUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        const photoInput = document.getElementById('photoInput');
        const photoCaption = document.getElementById('photoCaption').value;
        const isMain = document.getElementById('setAsMain').checked;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        if (!photoInput.files[0]) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
            return;
        }
        
        if (photoInput.files[0].size > 5 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
            return;
        }
        
        formData.append('image', photoInput.files[0]);
        formData.append('is_main', isMain);
        if (photoCaption) {
            formData.append('caption', photoCaption);
        }
        
        const uploadButton = document.getElementById('uploadButton');
        const originalText = uploadButton.innerHTML;
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...';
        
        fetch('/api/users/photos/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'Authorization': 'Bearer ' + validToken
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
            photoInput.value = '';
            document.getElementById('photoCaption').value = '';
            document.getElementById('setAsMain').checked = false;
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('photoManagerModal'));
            modal.hide();
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            try {
                const errorData = JSON.parse(error.message);
                if (errorData.image) {
                    errorMessage = errorData.image[0];
                }
            } catch (e) {
                errorMessage = error.message;
            }
            alert(errorMessage);
        })
        .finally(() => {
            uploadButton.disabled = false;
            uploadButton.innerHTML = originalText;
        });
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    document.querySelectorAll('.delete-photo').forEach(button => {
        button.addEventListener('click', function() {
            const photoId = this.dataset.photoId;
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                fetch(`/api/users/photos/${photoId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + validToken,
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É–¥–∞–ª–µ–Ω–∞');
                        location.reload();
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
                });
            }
        });
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('saveProfileChanges').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('profileEditForm'));
        
        const saveButton = this;
        const originalText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        fetch('/api/users/profiles/me/', {
            method: 'PUT',
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'Authorization': 'Bearer ' + validToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
            return response.json();
        })
        .then(data => {
            alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            location.reload();
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
        })
        .finally(() => {
            saveButton.disabled = false;
            saveButton.innerHTML = originalText;
        });
    });
});
</script>
{% endblock %}