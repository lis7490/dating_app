{% extends 'base.html' %}

{% block title %}LoveFinder - Мой профиль{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Основная информация -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Основная информация
                    </h5>
                </div>
                <div class="card-body text-center" id="profileMainContent">
                    {% if user.is_authenticated and user.profile %}
                    <div class="mb-3">
                        {% with main_photo=user.profile.photos.all|first %}
                        {% if main_photo and main_photo.is_main %}
                            <img src="{{ main_photo.image.url }}" class="rounded-circle" width="150" height="150" 
                                 style="object-fit: cover; cursor: pointer;" alt="Profile Photo"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTBkNWZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+0JjQvdC+0YMg0L/QvtC00LrQsNC30L3QsDwvdGV4dD4KPC9zdmc+'">
                        {% else %}
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTBkNWZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+0JjQvdC+0YMg0L/QvtC00LrQsNC30L3QsDwvdGV4dD4KPC9zdmc+" 
                                 class="rounded-circle" width="150" height="150" 
                                 style="object-fit: cover; cursor: pointer;" alt="Default Profile Photo">
                        {% endif %}
                        {% endwith %}
                    </div>
                    <h4>{{ user.get_full_name|default:user.username }}</h4>
                    <p class="text-muted">
                        {% if user.profile.age is not None %}
                            {{ user.profile.age }} лет,
                        {% endif %}
                        {{ user.profile.city|default:"Город не указан" }}
                    </p>
                    
                    <div class="mb-3">
                        <span class="badge bg-{{ user.profile.status_color|default:'secondary' }}">
                            {{ user.profile.get_status_display|default:"Не указан" }}
                        </span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <i class="fas fa-edit me-2"></i>Редактировать профиль
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-images me-2"></i>Управление фото
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-warning" id="noProfileAlert">
                        <p>Профиль не найден или не создан</p>
                        <button class="btn btn-sm btn-primary" id="createProfileBtn">
                            Создать профиль
                        </button>
                    </div>
                    <div id="profileContent" style="display: none;">
                        <!-- Сюда будет вставляться контент через JavaScript -->
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Статистика -->
            <div class="card mt-4" id="profileStats" style="display: none;">
                <div class="card-header">
                    <h6 class="mb-0">Статистика профиля</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-primary" id="likesCount">0</h5>
                            <small>Лайков</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-success" id="matchesCount">0</h5>
                            <small>Мэтчей</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-info" id="viewsCount">0</h5>
                            <small>Просмотров</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Детали профиля -->
        <div class="col-lg-8">
            <div id="profileDetails">
                {% if user.is_authenticated and user.profile %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">О себе</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-venus-mars me-2 text-muted"></i>Пол:</strong>
                                <span class="ms-2">{{ user.profile.get_gender_display|default:"Не указан" }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-birthday-cake me-2 text-muted"></i>Дата рождения:</strong>
                                <span class="ms-2">{{ user.profile.birth_date|default:"Не указана" }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>Город:</strong>
                                <span class="ms-2">{{ user.profile.city|default:"Не указан" }}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-heart me-2 text-muted"></i>Увлечения:</strong>
                            <div class="mt-2" id="hobbiesList">
                                {% if user.profile.hobbies %}
                                    {% for hobby in user.profile.hobbies_list %}
                                    <span class="badge bg-light text-dark me-1 mb-1">{{ hobby }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">Не указаны</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-file-alt me-2 text-muted"></i>О себе:</strong>
                            <p class="mt-2" id="profileBio">{{ user.profile.bio|default:"Пользователь пока не добавил информацию о себе." }}</p>
                        </div>
                    </div>
                </div>

                <!-- Фотогалерея -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Мои фотографии</h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-plus me-1"></i>Добавить фото
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="photo-gallery">
                            {% for photo in user.profile.photos.all %}
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="photo-container position-relative">
                                    <img src="{{ photo.image.url }}" class="img-fluid rounded" 
                                         style="height: 200px; width: 100%; object-fit: cover; cursor: pointer;"
                                         data-bs-toggle="modal" data-bs-target="#photoModal"
                                         data-photo-src="{{ photo.image.url }}"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSI+0J7RgtC/0YDQsNCy0LvQtdC90Lg8L3RleHQ+Cjwvc3ZnPg=='">
                                    {% if photo.is_main %}
                                    <span class="position-absolute top-0 start-0 badge bg-primary m-1">Основная</span>
                                    {% endif %}
                                    <div class="position-absolute top-0 end-0 m-1">
                                        <button class="btn btn-sm btn-outline-danger delete-photo" data-photo-id="{{ photo.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <small class="text-muted">{{ photo.caption|default:"Без названия" }}</small>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Фотографии не добавлены</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                                    <i class="fas fa-plus me-2"></i>Добавить первую фотографию
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card" id="emptyProfileCard">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h4>Профиль не создан</h4>
                        <p class="text-muted">Для просмотра и редактирования профиля необходимо его создать</p>
                        <button class="btn btn-primary btn-lg" id="createProfileBtnMain">
                            <i class="fas fa-plus me-2"></i>Создать профиль
                        </button>
                    </div>
                </div>
                <div id="profileDetailsContent" style="display: none;">
                    <!-- Сюда будет вставляться контент через JavaScript -->
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование профиля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileEditForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Имя</label>
                                <input type="text" class="form-control" name="first_name" id="editFirstName" value="{{ user.first_name }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Фамилия</label>
                                <input type="text" class="form-control" name="last_name" id="editLastName" value="{{ user.last_name }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Пол</label>
                        <select class="form-select" name="gender" id="editGender">
                            <option value="">Выберите пол</option>
                            <option value="M" {% if user.profile.gender == 'M' %}selected{% endif %}>Мужской</option>
                            <option value="F" {% if user.profile.gender == 'F' %}selected{% endif %}>Женский</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Дата рождения</label>
                        <input type="date" class="form-control" name="birth_date" id="editBirthDate" value="{{ user.profile.birth_date|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Город</label>
                        <input type="text" class="form-control" name="city" id="editCity" value="{{ user.profile.city }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Статус</label>
                        <select class="form-select" name="status" id="editStatus">
                            <option value="single" {% if user.profile.status == 'single' %}selected{% endif %}>В активном поиске</option>
                            <option value="dating" {% if user.profile.status == 'dating' %}selected{% endif %}>Встречаюсь</option>
                            <option value="married" {% if user.profile.status == 'married' %}selected{% endif %}>Женат/Замужем</option>
                            <option value="complicated" {% if user.profile.status == 'complicated' %}selected{% endif %}>Все сложно</option>
                            <option value="not_looking" {% if user.profile.status == 'not_looking' %}selected{% endif %}>Не ищу отношения</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Увлечения (через запятую)</label>
                        <textarea class="form-control" name="hobbies" id="editHobbies" rows="3" placeholder="Путешествия, музыка, спорт...">{{ user.profile.hobbies }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">О себе</label>
                        <textarea class="form-control" name="bio" id="editBio" rows="4" placeholder="Расскажите о себе...">{{ user.profile.bio }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveProfileChanges">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="photoManagerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление фотографиями</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="photoUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Добавить новую фотографию</label>
                        <input type="file" class="form-control" name="image" id="photoInput" accept="image/*" required>
                        <div class="form-text">Поддерживаемые форматы: JPG, PNG, GIF. Максимальный размер: 5MB</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Подпись к фото</label>
                        <input type="text" class="form-control" name="caption" id="photoCaption" placeholder="Необязательная подпись...">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_main" id="setAsMain">
                        <label class="form-check-label" for="setAsMain">
                            Сделать основной фотографией профиля
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="uploadButton">
                        <i class="fas fa-upload me-2"></i>Загрузить фотографию
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Просмотр фотографии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhoto" src="" class="img-fluid" style="max-height: 70vh; object-fit: contain;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Проверка и обновление JWT токена
async function checkAndRefreshToken() {
    const accessToken = localStorage.getItem('accessToken');
    const refreshToken = localStorage.getItem('refreshToken');
    
    if (!accessToken) {
        console.log('❌ Нет access token, перенаправляем на логин');
        window.location.href = '{% url "login" %}';
        return null;
    }
    
    try {
        const response = await fetch('/api/users/profiles/me/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            }
        });
        
        if (response.ok) {
            console.log('✅ Токен валиден');
            return accessToken;
        }
        
        if (response.status === 401 && refreshToken) {
            console.log('🔄 Токен истек, пробуем обновить...');
            const refreshResponse = await fetch('/api/token/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    refresh: refreshToken
                })
            });
            
            if (refreshResponse.ok) {
                const tokens = await refreshResponse.json();
                localStorage.setItem('accessToken', tokens.access);
                console.log('✅ Токен обновлен');
                return tokens.access;
            }
        }
        
        console.log('❌ Не удалось обновить токен');
        window.location.href = '{% url "login" %}';
        return null;
        
    } catch (error) {
        console.error('Ошибка проверки токена:', error);
        window.location.href = '{% url "login" %}';
        return null;
    }
}

// Функция для обновления интерфейса на основе данных API
function updateProfileUI(profileData) {
    console.log('🔄 Обновление интерфейса с данными:', profileData);
    
    if (profileData && profileData.id) {
        // Скрываем сообщения "Профиль не создан"
        const noProfileAlert = document.getElementById('noProfileAlert');
        const emptyProfileCard = document.getElementById('emptyProfileCard');
        
        if (noProfileAlert) noProfileAlert.style.display = 'none';
        if (emptyProfileCard) emptyProfileCard.style.display = 'none';
        
        // Обновляем основную информацию
        const profileContent = document.getElementById('profileContent');
        const profileDetailsContent = document.getElementById('profileDetailsContent');
        
        if (profileContent) {
            profileContent.style.display = 'block';
            profileContent.innerHTML = `
                <div class="mb-3">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZTBkNWZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+0JjQvdC+0YMg0L/QvtC00LrQsNC30L3QsDwvdGV4dD4KPC9zdmc+" 
                         class="rounded-circle" width="150" height="150" 
                         style="object-fit: cover; cursor: pointer;" alt="Profile Photo">
                </div>
                <h4>${profileData.first_name || ''} ${profileData.last_name || ''}</h4>
                <p class="text-muted">
                    ${profileData.age ? profileData.age + ' лет,' : ''}
                    ${profileData.city || 'Город не указан'}
                </p>
                
                <div class="mb-3">
                    <span class="badge bg-secondary">
                        ${profileData.status_display || 'Не указан'}
                    </span>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fas fa-edit me-2"></i>Редактировать профиль
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                        <i class="fas fa-images me-2"></i>Управление фото
                    </button>
                </div>
            `;
        }
        
        // Обновляем детали профиля
        if (profileDetailsContent) {
            profileDetailsContent.style.display = 'block';
            profileDetailsContent.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">О себе</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-venus-mars me-2 text-muted"></i>Пол:</strong>
                                <span class="ms-2">${profileData.gender === 'M' ? 'Мужской' : profileData.gender === 'F' ? 'Женский' : 'Не указан'}</span>
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-birthday-cake me-2 text-muted"></i>Дата рождения:</strong>
                                <span class="ms-2">${profileData.birth_date || 'Не указана'}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>Город:</strong>
                                <span class="ms-2">${profileData.city || 'Не указан'}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-heart me-2 text-muted"></i>Увлечения:</strong>
                            <div class="mt-2">
                                ${profileData.hobbies ? 
                                    profileData.hobbies.split(',').map(hobby => 
                                        `<span class="badge bg-light text-dark me-1 mb-1">${hobby.trim()}</span>`
                                    ).join('') : 
                                    '<span class="text-muted">Не указаны</span>'
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <strong><i class="fas fa-file-alt me-2 text-muted"></i>О себе:</strong>
                            <p class="mt-2">${profileData.bio || 'Пользователь пока не добавил информацию о себе.'}</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Мои фотографии</h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-plus me-1"></i>Добавить фото
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Фотографии не добавлены</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                                    <i class="fas fa-plus me-2"></i>Добавить первую фотографию
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Обновляем статистику
        const profileStats = document.getElementById('profileStats');
        if (profileStats) {
            profileStats.style.display = 'block';
            document.getElementById('likesCount').textContent = profileData.likes_count || 0;
            document.getElementById('matchesCount').textContent = profileData.matches_count || 0;
            document.getElementById('viewsCount').textContent = profileData.views_count || 0;
        }
        
        // Заполняем форму редактирования
        if (document.getElementById('editFirstName')) {
            document.getElementById('editFirstName').value = profileData.first_name || '';
            document.getElementById('editLastName').value = profileData.last_name || '';
            document.getElementById('editGender').value = profileData.gender || '';
            document.getElementById('editBirthDate').value = profileData.birth_date || '';
            document.getElementById('editCity').value = profileData.city || '';
            document.getElementById('editStatus').value = profileData.status || 'single';
            document.getElementById('editHobbies').value = profileData.hobbies || '';
            document.getElementById('editBio').value = profileData.bio || '';
        }
        
        console.log('✅ Интерфейс обновлен с данными профиля');
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    console.log('Profile page loaded');
    
    // Проверяем и получаем валидный токен
    const validToken = await checkAndRefreshToken();
    if (!validToken) {
        return;
    }
    
    console.log('Using valid token');
    
    // Загрузка данных профиля через API
    try {
        const response = await fetch('/api/users/profiles/me/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + validToken
            }
        });
        
        console.log('Profile API response status:', response.status);
        
        if (response.ok) {
            const profileData = await response.json();
            console.log('Profile data loaded:', profileData);
            updateProfileUI(profileData);
        } else {
            console.log('Profile load failed:', response.status);
        }
    } catch (error) {
        console.log('Profile load error:', error.message);
    }

    // Обработчики событий
    document.getElementById('createProfileBtn')?.addEventListener('click', function() {
        createProfile(validToken);
    });
    
    document.getElementById('createProfileBtnMain')?.addEventListener('click', function() {
        createProfile(validToken);
    });

    function createProfile(token) {
        fetch('/api/users/profiles/me/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                city: 'Не указан',
                bio: 'Новый профиль'
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Ошибка создания профиля');
        })
        .then(data => {
            alert('Профиль создан!');
            location.reload();
        })
        .catch(error => {
            alert('Ошибка: ' + error.message);
        });
    }

    // Просмотр фото в модальном окне
    document.querySelectorAll('[data-bs-target="#photoModal"]').forEach(element => {
        element.addEventListener('click', function() {
            const photoSrc = this.getAttribute('data-photo-src');
            document.getElementById('modalPhoto').src = photoSrc;
        });
    });

    // Загрузка фото
    document.getElementById('photoUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        const photoInput = document.getElementById('photoInput');
        const photoCaption = document.getElementById('photoCaption').value;
        const isMain = document.getElementById('setAsMain').checked;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        if (!photoInput.files[0]) {
            alert('Пожалуйста, выберите файл');
            return;
        }
        
        if (photoInput.files[0].size > 5 * 1024 * 1024) {
            alert('Файл слишком большой. Максимальный размер: 5MB');
            return;
        }
        
        formData.append('image', photoInput.files[0]);
        formData.append('is_main', isMain);
        if (photoCaption) {
            formData.append('caption', photoCaption);
        }
        
        const uploadButton = document.getElementById('uploadButton');
        const originalText = uploadButton.innerHTML;
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Загрузка...';
        
        fetch('/api/users/photos/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'Authorization': 'Bearer ' + validToken
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('Фотография успешно загружена!');
            photoInput.value = '';
            document.getElementById('photoCaption').value = '';
            document.getElementById('setAsMain').checked = false;
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('photoManagerModal'));
            modal.hide();
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            let errorMessage = 'Ошибка загрузки';
            try {
                const errorData = JSON.parse(error.message);
                if (errorData.image) {
                    errorMessage = errorData.image[0];
                }
            } catch (e) {
                errorMessage = error.message;
            }
            alert(errorMessage);
        })
        .finally(() => {
            uploadButton.disabled = false;
            uploadButton.innerHTML = originalText;
        });
    });

    // Удаление фото
    document.querySelectorAll('.delete-photo').forEach(button => {
        button.addEventListener('click', function() {
            const photoId = this.dataset.photoId;
            
            if (confirm('Удалить эту фотографию? Это действие нельзя отменить.')) {
                fetch(`/api/users/photos/${photoId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + validToken,
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Фотография удалена');
                        location.reload();
                    } else {
                        throw new Error('Ошибка удаления');
                    }
                })
                .catch(error => {
                    alert('Ошибка удаления: ' + error.message);
                });
            }
        });
    });

    // Сохранение профиля
    document.getElementById('saveProfileChanges').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('profileEditForm'));
        
        const saveButton = this;
        const originalText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Сохранение...';
        
        fetch('/api/users/profiles/me/', {
            method: 'PUT',
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'Authorization': 'Bearer ' + validToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка сохранения');
            }
            return response.json();
        })
        .then(data => {
            alert('Профиль успешно обновлен!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            location.reload();
        })
        .catch(error => {
            alert('Ошибка сохранения: ' + error.message);
        })
        .finally(() => {
            saveButton.disabled = false;
            saveButton.innerHTML = originalText;
        });
    });
});
</script>
{% endblock %}