{% extends 'base.html' %}

{% block title %}LoveFinder - Мой профиль{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- ОТЛАДОЧНАЯ ИНФОРМАЦИЯ - УДАЛИТЬ ПОСЛЕ ИСПРАВЛЕНИЯ -->
    <div class="alert alert-info mb-4">
        <h6>Отладочная информация:</h6>
        <p>User: {{ user }}</p>
        <p>Authenticated: {{ user.is_authenticated }}</p>
        <p>First Name: {{ user.first_name }}</p>
        <p>Last Name: {{ user.last_name }}</p>
        <p>Email: {{ user.email }}</p>
        <p>Profile exists: {% if user.profile %}Да{% else %}Нет{% endif %}</p>
        <p>Profile ID: {{ user.profile.id|default:"Нет профиля" }}</p>
    </div>

    <div class="row">
        <!-- Основная информация -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Основная информация
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if not user.profile %}
                    <div class="alert alert-warning">
                        <p>Профиль не найден или не создан</p>
                        <button class="btn btn-sm btn-primary" id="createProfileBtn">
                            Создать профиль
                        </button>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        {% with main_photo=user.profile.photos.all|first %}
                        {% if main_photo and main_photo.is_main %}
                            <img src="{{ main_photo.image.url }}" class="rounded-circle" width="150" height="150" 
                                 style="object-fit: cover; cursor: pointer;" alt="Profile Photo">
                        {% else %}
                            <img src="https://via.placeholder.com/150" class="rounded-circle" width="150" height="150" 
                                 style="object-fit: cover; cursor: pointer;" alt="Default Profile Photo">
                        {% endif %}
                        {% endwith %}
                    </div>
                    <h4>{{ user.get_full_name|default:user.username }}</h4>
                    <p class="text-muted">
                        {% if user.profile.age %}
                            {{ user.profile.age }} лет,
                        {% endif %}
                        {{ user.profile.city|default:"Город не указан" }}
                    </p>
                    
                    <div class="mb-3">
                        <span class="badge bg-{{ user.profile.status_color|default:'secondary' }}">
                            {{ user.profile.get_status_display|default:"Не указан" }}
                        </span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <i class="fas fa-edit me-2"></i>Редактировать профиль
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                            <i class="fas fa-images me-2"></i>Управление фото
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Статистика -->
            {% if user.profile %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">Статистика профиля</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-primary">{{ user.profile.likes_count|default:0 }}</h5>
                            <small>Лайков</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-success">{{ user.profile.matches_count|default:0 }}</h5>
                            <small>Мэтчей</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-info">{{ user.profile.views_count|default:0 }}</h5>
                            <small>Просмотров</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Детали профиля -->
        <div class="col-lg-8">
            {% if user.profile %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">О себе</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong><i class="fas fa-venus-mars me-2 text-muted"></i>Пол:</strong>
                            <span class="ms-2">{{ user.profile.get_gender_display|default:"Не указан" }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong><i class="fas fa-birthday-cake me-2 text-muted"></i>Дата рождения:</strong>
                            <span class="ms-2">{{ user.profile.birth_date|default:"Не указана" }}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>Город:</strong>
                            <span class="ms-2">{{ user.profile.city|default:"Не указан" }}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong><i class="fas fa-heart me-2 text-muted"></i>Увлечения:</strong>
                        <div class="mt-2">
                            {% if user.profile.hobbies %}
                                {% for hobby in user.profile.hobbies_list %}
                                <span class="badge bg-light text-dark me-1 mb-1">{{ hobby }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">Не указаны</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong><i class="fas fa-file-alt me-2 text-muted"></i>О себе:</strong>
                        <p class="mt-2">{{ user.profile.bio|default:"Пользователь пока не добавил информацию о себе." }}</p>
                    </div>
                </div>
            </div>

            <!-- Фотогалерея -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Мои фотографии</h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                        <i class="fas fa-plus me-1"></i>Добавить фото
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="photo-gallery">
                        {% for photo in user.profile.photos.all %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="photo-container position-relative">
                                <img src="{{ photo.image.url }}" class="img-fluid rounded" 
                                     style="height: 200px; width: 100%; object-fit: cover; cursor: pointer;"
                                     data-bs-toggle="modal" data-bs-target="#photoModal"
                                     data-photo-src="{{ photo.image.url }}"
                                     onerror="this.src='https://via.placeholder.com/300x200?text=Ошибка+загрузки'">
                                {% if photo.is_main %}
                                <span class="position-absolute top-0 start-0 badge bg-primary m-1">Основная</span>
                                {% endif %}
                                <div class="position-absolute top-0 end-0 m-1">
                                    <button class="btn btn-sm btn-outline-danger delete-photo" data-photo-id="{{ photo.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="mt-2 text-center">
                                    <small class="text-muted">{{ photo.caption|default:"Без названия" }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-images fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Фотографии не добавлены</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#photoManagerModal">
                                <i class="fas fa-plus me-2"></i>Добавить первую фотографию
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                    <h4>Профиль не создан</h4>
                    <p class="text-muted">Для просмотра и редактирования профиля необходимо его создать</p>
                    <button class="btn btn-primary btn-lg" id="createProfileBtnMain">
                        <i class="fas fa-plus me-2"></i>Создать профиль
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно редактирования профиля -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование профиля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileEditForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Имя</label>
                                <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Фамилия</label>
                                <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Пол</label>
                        <select class="form-select" name="gender">
                            <option value="">Выберите пол</option>
                            <option value="M" {% if user.profile.gender == 'M' %}selected{% endif %}>Мужской</option>
                            <option value="F" {% if user.profile.gender == 'F' %}selected{% endif %}>Женский</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Дата рождения</label>
                        <input type="date" class="form-control" name="birth_date" value="{{ user.profile.birth_date|date:'Y-m-d'|default:'' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Город</label>
                        <input type="text" class="form-control" name="city" value="{{ user.profile.city|default:'' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Статус</label>
                        <select class="form-select" name="status">
                            {% for status in user.profile.STATUS_CHOICES %}
                            <option value="{{ status.0 }}" {% if user.profile.status == status.0 %}selected{% endif %}>
                                {{ status.1 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Увлечения (через запятую)</label>
                        <textarea class="form-control" name="hobbies" rows="3" placeholder="Путешествия, музыка, спорт...">{{ user.profile.hobbies|default:'' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">О себе</label>
                        <textarea class="form-control" name="bio" rows="4" placeholder="Расскажите о себе...">{{ user.profile.bio|default:'' }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveProfileChanges">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно управления фото -->
<div class="modal fade" id="photoManagerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление фотографиями</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="photoUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Добавить новую фотографию</label>
                        <input type="file" class="form-control" name="image" id="photoInput" accept="image/*" required>
                        <div class="form-text">Поддерживаемые форматы: JPG, PNG, GIF. Максимальный размер: 5MB</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Подпись к фото</label>
                        <input type="text" class="form-control" name="caption" id="photoCaption" placeholder="Необязательная подпись...">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_main" id="setAsMain">
                        <label class="form-check-label" for="setAsMain">
                            Сделать основной фотографией профиля
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="uploadButton">
                        <i class="fas fa-upload me-2"></i>Загрузить фотографию
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра фото -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Просмотр фотографии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhoto" src="" class="img-fluid" style="max-height: 70vh; object-fit: contain;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Profile page loaded');
    console.log('Access token:', localStorage.getItem('accessToken') ? 'exists' : 'missing');

    // Проверка аутентификации при загрузке
    const accessToken = localStorage.getItem('accessToken');
    
    if (!accessToken) {
        alert('Требуется авторизация. Перенаправляем на страницу входа.');
        window.location.href = '{% url "login" %}';
        return;
    }
    
    console.log('Access token exists:', !!accessToken);
    
    // Загрузка данных профиля через API
    fetch('/api/users/profiles/me/', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + accessToken
        }
    })
    .then(response => {
        console.log('Profile API response status:', response.status);
        if (!response.ok) {
            throw new Error('Профиль не найден');
        }
        return response.json();
    })
    .then(profileData => {
        console.log('Profile data loaded:', profileData);
        // Здесь можно обновить интерфейс с полученными данными
    })
    .catch(error => {
        console.log('Profile load error:', error.message);
    });

    // Создание профиля если не существует
    document.getElementById('createProfileBtn')?.addEventListener('click', createProfile);
    document.getElementById('createProfileBtnMain')?.addEventListener('click', createProfile);

    function createProfile() {
        const accessToken = localStorage.getItem('accessToken');
        
        fetch('/api/users/profiles/me/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({
                city: 'Не указан',
                bio: 'Новый профиль'
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Ошибка создания профиля');
        })
        .then(data => {
            alert('Профиль создан!');
            location.reload();
        })
        .catch(error => {
            alert('Ошибка: ' + error.message);
        });
    }

    // Просмотр фото в модальном окне
    document.querySelectorAll('[data-bs-target="#photoModal"]').forEach(element => {
        element.addEventListener('click', function() {
            const photoSrc = this.getAttribute('data-photo-src');
            document.getElementById('modalPhoto').src = photoSrc;
        });
    });

    // Загрузка фото
    document.getElementById('photoUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Photo upload form submitted');
        
        const formData = new FormData();
        const photoInput = document.getElementById('photoInput');
        const photoCaption = document.getElementById('photoCaption').value;
        const isMain = document.getElementById('setAsMain').checked;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const accessToken = localStorage.getItem('accessToken');
        
        console.log('File selected:', photoInput.files[0]);
        console.log('Caption:', photoCaption);
        console.log('Is main:', isMain);
        
        if (!photoInput.files[0]) {
            alert('Пожалуйста, выберите файл');
            return;
        }
        
        // Проверка размера файла
        if (photoInput.files[0].size > 5 * 1024 * 1024) {
            alert('Файл слишком большой. Максимальный размер: 5MB');
            return;
        }
        
        if (!accessToken) {
            alert('Требуется авторизация. Пожалуйста, войдите снова.');
            window.location.href = '{% url "login" %}';
            return;
        }
        
        formData.append('image', photoInput.files[0]);
        formData.append('is_main', isMain);
        if (photoCaption) {
            formData.append('caption', photoCaption);
        }
        
        const uploadButton = document.getElementById('uploadButton');
        const originalText = uploadButton.innerHTML;
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Загрузка...';
        
        console.log('Sending request to /api/users/photos/');
        
        fetch('/api/users/photos/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'Authorization': 'Bearer ' + accessToken
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Server error:', text);
                    throw new Error(text);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Upload successful:', data);
            alert('Фотография успешно загружена!');
            
            // Сброс формы
            photoInput.value = '';
            document.getElementById('photoCaption').value = '';
            document.getElementById('setAsMain').checked = false;
            
            // Закрытие модального окна и перезагрузка
            const modal = bootstrap.Modal.getInstance(document.getElementById('photoManagerModal'));
            modal.hide();
            
            // Небольшая задержка перед перезагрузкой
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Upload error:', error);
            let errorMessage = 'Ошибка загрузки';
            try {
                const errorData = JSON.parse(error.message);
                if (errorData.image) {
                    errorMessage = errorData.image[0];
                }
            } catch (e) {
                errorMessage = error.message;
            }
            alert(errorMessage);
        })
        .finally(() => {
            uploadButton.disabled = false;
            uploadButton.innerHTML = originalText;
        });
    });

    // Удаление фото
    document.querySelectorAll('.delete-photo').forEach(button => {
        button.addEventListener('click', function() {
            const photoId = this.dataset.photoId;
            const accessToken = localStorage.getItem('accessToken');
            
            if (confirm('Удалить эту фотографию? Это действие нельзя отменить.')) {
                fetch(`/api/users/photos/${photoId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Фотография удалена');
                        location.reload();
                    } else {
                        throw new Error('Ошибка удаления');
                    }
                })
                .catch(error => {
                    alert('Ошибка удаления: ' + error.message);
                });
            }
        });
    });

    // Сохранение изменений профиля
    document.getElementById('saveProfileChanges').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('profileEditForm'));
        const accessToken = localStorage.getItem('accessToken');
        
        const saveButton = this;
        const originalText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Сохранение...';
        
        fetch('/api/users/profiles/me/', {
            method: 'PUT',
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'Authorization': 'Bearer ' + accessToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка сохранения');
            }
            return response.json();
        })
        .then(data => {
            alert('Профиль успешно обновлен!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            location.reload();
        })
        .catch(error => {
            alert('Ошибка сохранения: ' + error.message);
        })
        .finally(() => {
            saveButton.disabled = false;
            saveButton.innerHTML = originalText;
        });
    });
});
</script>
{% endblock %}